# v10.8.0 - Inline Stubs, Delegates, and Class Stubs

**Release Date:** 2026-01-07
**NuGet:** [KnockOff 10.8.0](https://nuget.org/packages/KnockOff/10.8.0)

## Overview

This release adds three new stub patterns and standardizes terminology:

1. **Inline Stubs** - Generate stubs inside test classes with `[KnockOff<TInterface>]`
2. **Delegate Stubs** - Stub named delegate types with `[KnockOff<TDelegate>]`
3. **Class Stubs** - Stub virtual/abstract class members via inheritance with `[KnockOff<TClass>]`
4. **Terminology** - "Handler" renamed to "Interceptor" throughout

## New Features

### Inline Stubs (`[KnockOff<TInterface>]`)

Generate stubs directly inside your test class:

```csharp
[KnockOff<IUserService>]
[KnockOff<ILogger>]
public partial class MyTests
{
    [Fact]
    public void Test()
    {
        var userStub = new Stubs.IUserService();
        userStub.GetUser.OnCall = (ko, id) => new User { Id = id };

        IUserService service = userStub;
        Assert.Equal(42, service.GetUser(42).Id);
    }
}
```

**Features:**
- Multiple `[KnockOff<T>]` attributes per class
- Nested `Stubs` class with full IntelliSense
- Optional partial property auto-instantiation (C# 13/.NET 9+)
- Direct instantiation: `new Stubs.IService()`

**Documentation:** [Inline Stubs Guide](../guides/inline-stubs.md)

### Delegate Stubs (`[KnockOff<TDelegate>]`)

Stub named delegate types for validation rules, factories, and callbacks:

```csharp
public delegate bool IsUniqueRule(string value);

[KnockOff<IsUniqueRule>]
public partial class ValidationTests
{
    [Fact]
    public void Test()
    {
        var stub = new Stubs.IsUniqueRule();
        stub.Interceptor.OnCall = (ko, value) => value != "duplicate";

        IsUniqueRule rule = stub;  // Implicit conversion
        Assert.True(rule("unique"));
        Assert.False(rule("duplicate"));
    }
}
```

**Features:**
- Implicit conversion to delegate type
- Full invocation tracking (`CallCount`, `LastCallArg`, etc.)
- Supports closed generic delegates (`[KnockOff<Factory<User>>]`)

**Documentation:** [Delegate Stubs Guide](../guides/delegates.md)

### Class Stubs (`[KnockOff<TClass>]`)

Stub virtual/abstract class members via inheritance:

```csharp
public class UserService
{
    public virtual User GetUser(int id) => LoadFromDb(id);
    public virtual string Name { get; set; }
}

[KnockOff<UserService>]
public partial class ServiceTests
{
    [Fact]
    public void Test()
    {
        var stub = new Stubs.UserService();
        stub.Interceptor.GetUser.OnCall = (ko, id) => new User { Id = id };

        UserService service = stub;  // Substitutable
        Assert.Equal(42, service.GetUser(42).Id);

        // Without OnCall, delegates to base implementation
        stub.Name = "Test";
        Assert.Equal("Test", stub.Name);
    }
}
```

**Features:**
- Inherits from target class (full substitutability)
- Only virtual/abstract members are intercepted
- Non-virtual members work through base class
- Constructor chaining supported

## New Diagnostics

| ID | Severity | Description |
|----|----------|-------------|
| KO1001 | Error | Type must be interface, class, or named delegate |
| KO1002 | Error | Name collision (same simple name from different namespaces) |
| KO1003 | Error | `Stubs` type already exists in scope |
| KO2001 | Error | Cannot stub sealed class |
| KO2002 | Error | No accessible constructors |
| KO2003 | Info | Non-virtual member skipped |
| KO2004 | Warning | No virtual members to intercept |
| KO2005 | Error | Cannot stub static class |
| KO2006 | Error | Cannot stub built-in type |

## Terminology Change: Handler → Interceptor

Generated tracking/callback classes now use "Interceptor" naming:

| Before (v10.7.0) | After (v10.8.0) |
|------------------|-----------------|
| `IUserService_GetUserHandler` | `IUserService_GetUserInterceptor` |
| `IUserServiceKO` | `IUserServiceInterceptors` |

**Most code is unaffected.** The common access pattern remains unchanged:

```csharp
// Still works exactly the same
knockOff.IUserService.GetUser.CallCount
knockOff.IUserService.GetUser.OnCall = (ko, id) => new User();
```

## Migration from v10.7.0

1. **No code changes required** for typical usage patterns
2. If you reference generated class types directly, update:
   - `{Interface}KO` → `{Interface}Interceptors`
   - `{Interface}_{Member}Handler` → `{Interface}_{Member}Interceptor`

---

**Full Changelog**: https://github.com/NeatooDotNet/KnockOff/compare/v10.7.0...v10.8.0
