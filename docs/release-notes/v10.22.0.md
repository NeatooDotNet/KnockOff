# KnockOff v10.22.0

**Release Date:** 2026-01-17
**Breaking Changes:** No

---

## Summary

Bug fix for `LastCallArg` and `LastCallArgs` backward-compatible properties returning arguments from the wrong registration when using call sequences.

---

## What's New

### Bug Fix: LastCallArg/LastCallArgs with Sequences

The `LastCallArg` and `LastCallArgs` properties now correctly return arguments from the **most recent** call when using sequences with `OnCall().ThenCall()`.

**Before:** Returned arguments from the FIRST called registration:

```csharp
var knockOff = new UserServiceKnockOff();
IUserService service = knockOff;

// Set up sequence
knockOff.GetById
    .OnCall((ko, id) => new User { Id = 100 }, Times.Once)
    .ThenCall((ko, id) => new User { Id = 200 }, Times.Forever);

service.GetById(1);  // Uses first registration
service.GetById(2);  // Uses second registration

// BUG: Returned 1 (from first registration) instead of 2 (from most recent call)
var lastId = knockOff.GetById.LastCallArg;
```

**After:** Returns arguments from the most recent call:

```csharp
// Same setup and calls as above

// FIXED: Returns 2 (from most recent call, which used second registration)
var lastId = knockOff.GetById.LastCallArg;  // âœ“ 2
```

This fix also applies to `LastCallArgs` for methods with multiple parameters.

---

## Technical Details

The backward-compatible `LastCallArg` and `LastCallArgs` properties previously used forward iteration through the sequence list:

```csharp
// Before (buggy)
foreach (var s in _sequence)
    if (s.Tracking.CallCount > 0)
        return s.Tracking.LastArg;
```

This returned the `LastArg` from the **first registration** that had been called, not the registration used by the **most recent call**.

The fix changes to reverse iteration to find the most recently used registration:

```csharp
// After (fixed)
for (int i = _sequence.Count - 1; i >= 0; i--)
    if (_sequence[i].Tracking.CallCount > 0)
        return _sequence[i].Tracking.LastArg;
```

Regression tests were added to `InterceptorApiSamplesTests.cs` to verify this behavior.

---

## Migration Guide

No migration required. This is a drop-in replacement for v10.21.0.

If you were using `LastCallArg` or `LastCallArgs` with sequences, the properties now correctly return arguments from the most recent call instead of the first called registration.
