# v10.7.0 - Breaking Changes Release

**Release Date:** 2026-01-06
**NuGet:** [KnockOff 10.7.0](https://nuget.org/packages/KnockOff/10.7.0)

## Overview

This release contains two breaking changes:
1. **Handler class rename**: `{Interface}Spy` → `{Interface}KO`
2. **Zero-allocation tracking**: Removed `AllCalls`, `AllGetKeys`, `AllSetEntries`

## Breaking Changes

### Handler Class Rename (Spy → KO)

Generated handler classes have been renamed from `{Interface}Spy` to `{Interface}KO`:

| Before | After |
|--------|-------|
| `ILoggerSpy` | `ILoggerKO` |
| `IUserServiceSpy` | `IUserServiceKO` |
| `IRepository_UserSpy` | `IRepository_UserKO` |

**Most code is unaffected.** The common access pattern via interface properties remains unchanged:

```csharp
// Still works exactly the same
knockOff.ILogger.Log.CallCount
knockOff.IUserService.Name.OnGet = (ko) => "Test";
```

**Only affected** if you directly reference the handler class type:

```csharp
// Before (v10.6.0)
ILoggerSpy spy = knockOff.ILogger;

// After (v10.7.0)
ILoggerKO ko = knockOff.ILogger;
```

### Removed Properties

The following properties have been removed from all handlers:

| Handler Type | Removed Properties |
|--------------|-------------------|
| Method | `AllCalls` |
| Indexer | `AllGetKeys`, `AllSetEntries` |
| Generic Method `.Of<T>()` | `AllCalls` |

### Migration

**Before (v10.6.0 and earlier):**
```csharp
// Method tracking
var allCalls = knockOff.IService.GetUser.AllCalls;
Assert.Equal(3, allCalls.Count);
Assert.Equal(42, allCalls[0]);

// Indexer tracking
var allKeys = knockOff.ICache.StringIndexer.AllGetKeys;
var allEntries = knockOff.ICache.StringIndexer.AllSetEntries;
```

**After (v10.7.0):**
```csharp
// Method tracking - use CallCount and LastCallArg
Assert.Equal(3, knockOff.IService.GetUser.CallCount);
Assert.Equal(42, knockOff.IService.GetUser.LastCallArg);

// Indexer tracking - use counts and last values
Assert.Equal(3, knockOff.ICache.StringIndexer.GetCount);
Assert.Equal("key3", knockOff.ICache.StringIndexer.LastGetKey);
Assert.Equal(("key3", value3), knockOff.ICache.StringIndexer.LastSetEntry);
```

### For Full Call History

If you need to track all calls (not just the last one), use an `OnCall` callback:

```csharp
var allCalls = new List<int>();
knockOff.IService.GetUser.OnCall = (ko, id) =>
{
    allCalls.Add(id);
    return new User { Id = id };
};

// ... run test ...

Assert.Equal([1, 2, 3], allCalls);
```

## Rationale

The `List<T>` backing `AllCalls` caused unbounded memory allocation during benchmarks, resulting in GC pressure that made benchmarks unreliable (NA results). Replacing List-based tracking with simple auto-properties eliminates allocations in the hot path:

**Before:**
```csharp
private readonly List<T> _calls = new();
public int CallCount => _calls.Count;
public T? LastCallArg => _calls.Count > 0 ? _calls[^1] : null;
public IReadOnlyList<T> AllCalls => _calls;
public void RecordCall(T arg) => _calls.Add(arg);  // Allocates!
```

**After:**
```csharp
public int CallCount { get; private set; }
public T? LastCallArg { get; private set; }
public void RecordCall(T arg) { CallCount++; LastCallArg = arg; }  // Zero allocations
```

## Performance Results

Benchmarks now show zero allocations and consistent measurements:

| Method | Mean | Allocated |
|--------|------|-----------|
| KnockOff_Verify | 7.8 ns | 0 B |
| Moq_Verify | 3,280 ns | 1,280 B |

KnockOff is now **420x faster** than Moq for verification with **zero allocations**.

## What's Retained

All other tracking remains unchanged:
- `CallCount` - Number of calls
- `WasCalled` - Boolean shorthand for `CallCount > 0`
- `LastCallArg` / `LastCallArgs` - Last call arguments
- `OnCall` callbacks - Full control over behavior
- `Reset()` - Clears tracking and callbacks

---

**Full Changelog**: https://github.com/NeatooDotNet/KnockOff/compare/v10.6.0...v10.7.0
